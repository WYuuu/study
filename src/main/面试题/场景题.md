# Table of Contents

* [11月3号](#11月3号)
* [11月4号](#11月4号)
* [11月9号](#11月9号)
* [参考资料](#参考资料)




> 没有最优的解决方案，只有最适合业务场景的方案。





# 11月3号

小猛同学正在压测，发现个小问题，因为在终端设备上跟鹅厂有紧密合作，调用他们的接口时需要获取到access_token，但是这个access_token过期时间是2小时，过期后需要重新获取。



压测时发现当到达过期时间时，日志看刷出来好几个不一样的access_token，因为这个服务也是分布式部署的，多个节点同时发起了第三方接口请求导致。



虽然以最后一次获取的access_token为准，也没什么不良副作用，但是会导致多次不必要的对第三方接口的调用，也会短时间内造成access_token的 重复无效获取



问题：请大家思考一下，通过什么技术解决上面的业务场景？



思考这个问题怎么思考？

1. token放哪里？Redis mysql？为什么要用Mysql?防止Redis宕机，不过一般环境，不太需求双写
2. token存放有效期是多久？一般都是少于当前token过期时间。
3. 多线程环境下，获取系统的token是否要加锁？不加锁是不是会导致token多次刷新？



# 11月4号

小猛同学在某公司的大数据部门，现在要做一个高并发的同步系统，把某个业务的数据同步到自己的系统中，然后在做各种复杂的操作后提供接口给其他部门查询，每天日同步数据要达到上千万级别。



整个数据同步前期流程是从一个 mysql 库原封不动地同步到另一个 mysql 库里面去（mysql -> mysql）。



小猛同学初步架构设计是：从一个mysql监听到binlog后发送消息到MQ中，另外一个服务在消费MQ中的数据写到自己的库中，但是现在存在一个问题。



多个业务系统执行sql往mysql 里增删改对应的数据，但是小猛发现自己这边库的数据有时候跟**业务方的库数据不一致**。



二、大家思考上面问题产生原因，如何去解决上面的技术问题？



这道题我开始理解错意思了。【业务数据不一致】要怎么理解呢？【因为同步的时候sql顺序同步顺序不一定导致的】



1. 第一个，为什么要用MQ?有直接的数据同步工具。比如alibaba otter、离线dataX、kettle等
2. Mysql的binglog是不是设置的`statement`,在RC下会有SQL顺序不一致的情况，使用`Row`格式会比较好，
3. 在使用MQ的前提下，要保证数据的顺序性**（格外引入中间件，会有开销）**
   	+  只用一个分区
      	+  使用多个分区，用类似滑动窗口来解决顺序问题。

4. 可以直接讲自己的库作为【从库】，主从同步。本身就有机制。



# 11月9号
 一、业务场景

小猛最近出去面试，面试官出了一道关于双十一的题目，内容如下：我们工作中有时候会遇到一些突发的情况，比如某电商机构双十一期间的某些热门商品会有降价促销的活动，当这其中某一件商品被数万次点击浏览或者购买时，会有一个短期的较大的流量，造成热点问题。你觉得后台服务会有哪些瓶颈，如何去解决这些问题？

二、大家思考一下，系统会遇到哪些问题？如何优化系统的整体架构来解决这些问题？


以下是个人理解：

高并发的三大法宝：限流、降级、熔断。

对于上述场景题，最容易出现的一个问题就是，多次请求热点key问题，以及缓存击穿问题。

![image-20211225113613963](.images/image-20211225113613963.png)



官方思路：



主要问题：某一热点Key的流量集中达到某一主机上，缓存集群开始出现机器的宕机，此时读请求读不到数据读db，DB被击穿，引起业务雪崩



解决方案：



核心思路：你的系统需要能够在热点缓存突然发生的时候，直接发现他，然后瞬间立马实现毫秒级的自动负载均衡



1、你如何自动发现热点缓存问题？



比如通过大数据的flink技术来计算，一旦发现某一秒内的请求达到了某个阀值，判断为热点key，写入到zk中



2、热点缓存自动加载为JVM本地缓存



我们的业务系统可以去监听zk的node节点，把数据加载出来后放入到系统的本地缓存，比如ehcache、自己实现的LRU Cache Map都可以



3、限流熔断保护



每个服务实例加入熔断机制，请求达到一定阀值后直接返回一个空白的页面，不让请求访问缓存集群和db



> 个人理解：首先分析问题重点，再看如何解决问题？
> 如何解决问题，这个就设计比较广泛了，需要你对各个知识点比较融会贯通。


# 参考资料

【】https://www.yuque.com/docs/share/836480c7-69d9-4488-8834-81c224dcd009#%E3%80%8A%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%E6%B1%87%E6%80%BB%E3%80%8B

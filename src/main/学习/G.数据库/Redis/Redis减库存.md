# Table of Contents



将“实时扣库存”的行为上移到内存Cache中操作，内存Cache操作成功直接给Server返回成功，然后异步落DB持久化

**使用思路：**

1. 【**缓存预热**】系统初始化的时候，将商品库存加载到Redis 缓存中保存

2. 【**扣减库存，防止超卖**】收到请求的时候,现在Redis中拿到该商品的库存值，进行库存预减，如果减完之后库存不足，直接返回逻辑Exception就不需要访问数据库再去减库存了，如果库存值正确，进行下一步

   > + redis事务Watch机制，去监听库存数量，一旦库存数量在其他客户端发生改变，后续操作则会失败。
   > + redis事务Lua脚本处理，判断数量为0返回异常。
   > + 放入Redis队列

3. 将请求入队，立即给前端返回一个值，表示正在排队中，然后进行秒杀逻辑，后端队列进行秒杀逻辑，前端轮询后端发来的请求，如果秒杀成功，返回秒杀，成功，不成功就返回失败。

4. 异步落DB持久化



**注意事项**：

- 优点是用内存操作替代磁盘操作，提高了并发性能. 
- 但是缺点也很明显，在内存操作成功但DB持久化失败，或者内存Cache故障的情况下，DB持化会丢数据，不适合微信红包这种资金交易系统。

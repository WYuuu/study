# Table of Contents

* [优雅下线设计点](#优雅下线设计点)
* [注销实例接口](#注销实例接口)
* [K8S配置服务下线](#k8s配置服务下线)
* [参考资料](#参考资料)








服务部署，是一个避免不了的问题。按正常迭代的速度一般两周会发一个版本，此时就需要部署新的代码。发布方式，我相信主流的都是用滚动发布，因为这样的成本是最低的，机器数量是固定的，一台台机器轮流发布。

 

但是我们总会在发布过程中碰到一些报错信息，那是因为请求还没结束，某些组件已经强制停止了，比如我们的数据源，比如异步任务还没处理完。

 

那么如何解决这个问题呢？那就是服务优雅下线，估计大家都听过这个词，但我不知道有多少做到了随时发布都不影响功能的正常使用。





# 优雅下线设计点

+ 外部请求必须处理完

  一般系统发布都会有一个通知，称为**发版时间**

+ 内部异步任务需要处理完

  丢给线程池的任务，需要持久化。

  > 目前采用的是本地消息表的方式，
  >
  > 数据源->消息通知表->定时任务处理

+ 消息必须消费完

   这里指的是kafka的数据，如果实例宕机，消息没有提交，**代码中需要注意消息重复的问题**。





# 注销实例接口

- 写一个停止流量的接口，在接口中将本身实例从注册中心，MQ进行下线操作。

- 写一个检测流量是否结束的接口，在接口中判断当前是否还有正在工作的线程，有没有正在处理的消息，有没有正在执行的异步任务等等。

  > Q:如何判断当前服务还有没有工作的线程？
  >
  > A：Thread.activeCount() ？ 不太确定

  

- 当完全没有流量的时候，发布平台直接对当前进程进行kill操作，此时所有任务都已执行完并且没有新流量进来，无损操作。

- 执行发布流程。

这里其实涉及到一个点，就是假如3分钟了，还是有任务在处理，那么是否要强制中断？



这里其实可以这么做，就是我们的服务本身的实例一旦下线，正常的话几秒钟后就应该没有任务了，因为对外的接口基本上都是毫秒级响应。主要就怕异步任务，比如线程池里堆积了好多任务等待执行，所以大家需要去梳理下，如果有这种场景就调整，不要往线程池里堆积任务，这样才能保证在下流量的时候能够尽快执行完成。



# K8S配置服务下线

容器配置是可以配置一个：脚本**调用注销实例接口**



当新版本发布的时候，

+ 灰度版本
+ 流量转发
+ 调用注销实例接口
+ 进行注销





# 参考资料

https://mp.weixin.qq.com/s/E-kL9y6049vPv9bZ7Zs-Iw

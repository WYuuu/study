

# 使用介绍
https://mp.weixin.qq.com/s/WisNStCsK5Mf4w_r8ytdYw

# 

# 你会如何设计一个注册中心

+ 服务注册和发现。
+ 服务之间的心跳机制
+ 单体故障怎么办 是不是要做集群



我们要做的就是，

1. 维护一个注册表,记录注册的服务
2. 维护一个心跳机制，如果服务不可用，剔除
3. 客户端如何拉取。
4. 服务端需要做集群，服务端是不是还要维护一个可用集群列表。



# 原理

在推送请求和拉取请求这件事上，推送注册表是一个写操作，而拉取注册表是一个读操作。

写与读是有一个冲突的问题的，在eureka中为了避免读写的冲突，**采用了多级缓存**，延迟加载，通过最终一致性来解决读写冲突。

1. 服务端把服务地址推送到注册表。
2. 此时立马把注册表同步到读写缓存。
3. 内部用一个线程来定时的吧读写缓存中的数据推送到只读缓存。
4. 客户端定时的从只读缓存中读取配置。如果只读缓存没有数据，则去读写缓存拉取，如果有则拉取，如果没有则去注册表拉取。
5. 注册中心还应该有一个心跳机制，定期的检查注册表中的服务是否可用。就是发送心跳包给服务提供端，如果正常则不操作。如果服务端服务不正常则将这个服务从注册表踢出，并质空读写缓存。
6. 客户端应该知道注册中心的全部地址，客户端加一个心跳机制，来检查注册中心是否存活，如果不存活尝试链接其他的注册中心；另外多个注册中心应该有一个互通获取服务注册表信息的功能。





# 如何设计注册表？

现在咱们假设手头有一套大型的分布式系统，一共100个服务，每个服务部署在20台机器上，机器是4核8G的标准配置。

也就是说，相当于你一共部署了100 * 20 = 2000个服务实例，有2000台机器。

每台机器上的服务实例内部都有一个Eureka Client组件，它会**每隔30秒**请求一次Eureka Server，拉取变化的注册表。

此外，每个服务实例上的Eureka Client都会每隔30秒发送一次心跳请求给Eureka Server。

那么大家算算，Eureka Server作为一个微服务注册中心，**每秒钟要被请求多少次？一天要被请求多少次？**

- 按标准的算法，每个服务实例每分钟请求2次拉取注册表，每分钟请求2次发送心跳
- 这样一个服务实例每分钟会请求4次，2000个服务实例每分钟请求8000次
- 换算到每秒，则是8000 / 60 = 133次左右，我们就大概估算为Eureka Server每秒会被请求150次
- 那一天的话，就是8000 * 60 * 24 = 1152万，也就是**每天千万级访问量**



## 源码分析

**一句话概括：维护注册表、拉取注册表、更新心跳时间，全部发生在内存里！这是Eureka Server非常核心的一个点。**

![](.images/下载.png)


+ 为什么要用map这种数据结构存储注册表数据？

答：速度快、效率高，因为是从内存中进行数据的存取，要比操作数据库要快得多。

+ 为什么要使用ConcurrentHashMap这种数据结构？

答：为了支持并发。
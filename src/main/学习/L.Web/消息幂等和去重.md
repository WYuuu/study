# Table of Contents

* [什么是幂等？](#什么是幂等)
* [insert前先select](#insert前先select)
* [数据库悲观锁](#数据库悲观锁)
* [数据库乐观锁](#数据库乐观锁)
* [唯一索引（数据库/Setnx）](#唯一索引数据库setnx)
* [建防重表](#建防重表)
* [分布式锁](#分布式锁)
* [Token](#token)
* [你们项目如何应用？](#你们项目如何应用)
* [参考资料](#参考资料)



# 什么是幂等？

 接口幂等性是指用户对于**同一操作发起的一次请求或者多次请求的结果是一致的**，不会因为多次点击而产生了副作用。 



 防重设计 和 幂等设计，其实是有区别的。

+ 防重设计主要为了避免产生重复数据，对接口返回没有太多要求。

  > 对请求或者消息在【一定时间内】去重。

+ 而幂等设计除了避免产生重复数据之外，还要求每次请求都返回一样的结果。 



**幂等和去重的本质：【唯一Key】+【存储】**

# insert前先select

 通常情况下，在保存数据的接口中，我们为了防止产生重复数据，一般会在insert前，先根据name或code字段select一下数据。如果该数据已存在，则执行update操作，如果不存在，才执行 insert操作。 



**但是并发情况下是会有问题的！**



# 数据库悲观锁

```Mysql
select * from user id=123 for update;
```



问题：

1. 如果使用的是mysql数据库，存储引擎必须用innodb，因为它才支持事务。此外，这里id字段一定要是主键或者唯一索引，不然会锁住整张表



# 数据库乐观锁

 乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。
乐观锁的实现方式多种多样可以通过version或者其他状态条件： 

# 唯一索引（数据库/Setnx）

 绝大数情况下，为了防止重复数据的产生，我们都会在表中加唯一索引，这是一个非常简单，并且有效的方案。 


加了唯一索引之后，第一次请求数据可以插入成功。但后面的相同请求，插入数据时会报Duplicate entry '002' for key 'order.un_code异常，表示唯一索引有冲突。

虽说抛异常对数据来说没有影响，不会造成错误数据。但是为了保证接口幂等性，我们需要对该异常进行捕获，然后返回成功。

如果是java程序需要捕获：DuplicateKeyException异常，如果使用了spring框架还需要捕获：MySQLIntegrityConstraintViolationException异常。



# 建防重表

有时候表中并非所有的场景都不允许产生重复的数据，只有某些特定场景才不允许。这时候，直接在表中加唯一索引，显然是不太合适的。



> 其实也是加锁

使用订单号orderNo做为去重表的唯一索引，每次请求都根据订单号向去重表中插入一条数据。第一次请求查询订单支付状态，当然订单没有支付，进行支付操作，无论成功与否，执行完后更新订单状态为成功或失败，删除去重表中的数据。后续的订单因为表中唯一索引而插入失败，则返回操作失败，直到第一次的请求完成（成功或失败）。可以看出防重表作用是加锁的功能。

具体步骤：

1. 用户通过浏览器发起请求，服务端收集数据。
2. 将该数据插入mysql防重表
3. 判断是否执行成功，如果成功，则做mysql其他的数据操作（可能还有其他的业务逻辑）。
4. 后续因为表中唯一索引而插入失败，捕获唯一索引冲突异常，直接返回成功。

> 需要特别注意的是：防重表和业务表必须在同一个数据库中，并且操作要在同一个事务中。



# 分布式锁



# Token

防止页面重复提交。

原理上通过session token来实现的(**也可以通过redis来实现**)。

+  数据提交前要向服务的申请token，token放到redis或jvm内存，token有效时间；
+  前端提交后，后台校验token，同时删除token 



# 你们项目如何应用？

1. 页面提交用token
2. 有状态机的是用状态机
3. 分布式锁
4. 唯一索引和防重表。





# 参考资料

https://mp.weixin.qq.com/s/qKCpo9x8PjkiYVE12YWnqQ

https://mp.weixin.qq.com/s?__biz=MzU4NzA3MTc5Mg==&mid=2247484848&idx=1&sn=936898b5e5a2cb1a82b4b017a7c811d5&chksm=fdf0edefca8764f9b14525354cb701354a59d62619ed7e7c99050e9a53f153d1cb320998a24b&scene=178&cur_album_id=1657204970858872832#rd
